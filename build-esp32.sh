#!/bin/bash -x

# Convenience script to build libpcap.a for the ESP32 platform.  This
# assumes that you've installed the toolchain in your home directory.

export ESP32_HOME=~/.arduino15/packages/esp32
export ESP32_VERSION=2.0.6
export ESP32_TOOLCHAIN_PATH=${ESP32_HOME}/tools/xtensa-esp32-elf-gcc/gcc8_4_0-esp-2021r2-patch5/bin

# Installation destination:
export ESP_DESTDIR=${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/libpcap

# Defines for ESP32 builds:
#export ESP32_CDEFINES="-DLWIP_COMPAT_SOCKETS -DESP_SOCKET -DLWIP_COMPAT_SOCKET_ADDR=1 -DUNITY_INCLUDE_CONFIG_H -DWITH_POSIX -D_GNU_SOURCE -DIDF_VER=\"v4.4.2\" -DESP_PLATFORM -D_POSIX_READER_WRITER_LOCKS -Dmain=app_main"
export ESP32_CDEFINES="-DLWIP_COMPAT_SOCKETS -DESP_SOCKET -DLWIP_COMPAT_SOCKET_ADDR=1 -DUNITY_INCLUDE_CONFIG_H -DWITH_POSIX -DIDF_VER=\"v4.4.2\" -DESP_PLATFORM -D_POSIX_READER_WRITER_LOCKS -Dmain=app_main -DNI_NUMERICHOST=0 -DOpenSSL_add_ssl_algorithms=SSL_library_init -DSSL_COMP_get_compression_methods=SSL_library_init -DSSL_MODE_AUTO_RETRY=0 -DSSL_FILETYPE_PEM=1"


export ESP32_CINCLUDES="-I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/newlib/platform_include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/freertos/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/freertos/include/esp_additions/freertos -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/freertos/port/xtensa/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/freertos/include/esp_additions -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/esp_hw_support/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/heap/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/lwip/include/apps -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/lwip/lwip/src/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/lwip/port/esp32/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/soc/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/soc/esp32/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/hal/esp32/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/hal/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/esp_rom/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/esp_common/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/esp_system/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/pthread/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/xtensa/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/xtensa/esp32/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/esp_wifi/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/esp_event/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/esp_netif/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/esp_eth/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/tcpip_adapter/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/esp_timer/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/spiffs/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/qio_qspi/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/inlcude/libcrypt/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/openssl/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/mbedtls/include -I${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/log/include"

#TODO: verify and cull as needed
export ESP32_CFLAGS="-mlongcalls -Wno-frame-address -ffunction-sections -fdata-sections -Wno-error=unused-function -Wno-error=unused-variable -Wno-error=deprecated-declarations -Wno-unused-parameter -Wno-sign-compare -ggdb -Os -freorder-blocks -Wwrite-strings -fstack-protector -fstrict-volatile-bitfields -Wno-error=unused-but-set-variable -Wno-error=implicit-function-declaration -fno-jump-tables -fno-tree-switch-conversion"
#export ESP32_CFLAGS=""

export ESP32_LDFLAGS="-L${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/lib -L${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/ld -L${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/qio_qspi -L${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/libcrypt/lib -T esp32.rom.redefined.ld -T memory.ld -T sections.ld -T esp32.rom.ld -T esp32.rom.api.ld -T esp32.rom.libgcc.ld -T esp32.rom.newlib-data.ld -T esp32.rom.syscalls.ld -T esp32.peripherals.ld -mlongcalls -Wno-frame-address -Wl,--cref -Wl,--gc-sections -fno-lto -Wl,--wrap=esp_log_write -Wl,--wrap=esp_log_writev -Wl,--wrap=log_printf -u ld_include_hli_vectors_bt -u _Z5setupv -u _Z4loopv -u esp_app_desc -u pthread_include_pthread_impl -u pthread_include_pthread_cond_impl -u pthread_include_pthread_local_storage_impl -u pthread_include_pthread_rwlock_impl -u include_esp_phy_override -u ld_include_highint_hdl -u start_app -u start_app_other_cores -u __ubsan_include -Wl,--wrap=longjmp -u __assert_func -u vfs_include_syscalls_impl -Wl,--undefined=uxTopUsedPriority -u newlib_include_heap_impl -u newlib_include_syscalls_impl -u newlib_include_pthread_impl -u newlib_include_assert_impl -u __cxa_guard_dummy"

export ESP32_LDADD="-lesp_ringbuf -lefuse -lesp_ipc -ldriver -lesp_pm -lmbedtls -lapp_update -lbootloader_support -lspi_flash -lnvs_flash -lpthread -lesp_gdbstub -lespcoredump -lesp_phy -lesp_system -lesp_rom -lhal -lvfs -lesp_eth -ltcpip_adapter -lesp_netif -lesp_event -lwpa_supplicant -lesp_wifi -lconsole -lopenssl -llwip -llog -lheap -lsoc -lesp_hw_support -lxtensa -lesp_common -lesp_timer -lfreertos -lnewlib -lcxx -lapp_trace -lasio -lbt -lcbor -lunity -lcmock -lcoap -lnghttp -lesp-tls -lesp_adc_cal -lesp_hid -ltcp_transport -lesp_http_client -lesp_http_server -lesp_https_ota -lesp_https_server -lesp_lcd -lprotobuf-c -lprotocomm -lmdns -lesp_local_ctrl -lsdmmc -lesp_serial_slave_link -lesp_websocket_client -lexpat -lwear_levelling -lfatfs -lfreemodbus -ljsmn -ljson -llibsodium -lmqtt -lopenssl -lperfmon -lspiffs -lulp -lwifi_provisioning -lrmaker_common -ljson_parser -ljson_generator -lesp_schedule -lesp_rainmaker -lgpio_button -lqrcode -lws2812_led -lesp_diagnostics -lrtc_store -lesp_insights -lesp-dsp -lesp-sr -lesp32-camera -lesp_littlefs -lfb_gfx -lasio -lcmock -lunity -lcoap -lesp_lcd -lesp_websocket_client -lexpat -lfreemodbus -ljsmn -llibsodium -lperfmon -lcbor -lesp_diagnostics -lrtc_store -lesp_adc_cal -lesp_hid -lfatfs -lwear_levelling -lopenssl -lesp_rainmaker -lesp_local_ctrl -lesp_https_server -lwifi_provisioning -lprotocomm -lbt -lbtdm_app -lprotobuf-c -lmdns -lrmaker_common -lmqtt -ljson_parser -ljson_generator -lesp_schedule -lqrcode -lcat_face_detect -lhuman_face_detect -lcolor_detect -lmfn -ldl -lmultinet -lesp_audio_processor -lesp_audio_front_end -lwakenet -lesp-sr -lmultinet -lesp_audio_processor -lesp_audio_front_end -lwakenet -ljson -lspiffs -ldl_lib -lc_speech_features -lwakeword_model -lmultinet2_ch -lesp_tts_chinese -lvoice_set_xiaole -lesp_ringbuf -lefuse -lesp_ipc -ldriver -lesp_pm -lmbedtls -lapp_update -lbootloader_support -lspi_flash -lnvs_flash -lpthread -lesp_gdbstub -lespcoredump -lesp_phy -lesp_system -lesp_rom -lhal -lvfs -lesp_eth -ltcpip_adapter -lesp_netif -lesp_event -lwpa_supplicant -lesp_wifi -lconsole -llwip -llog -lheap -lsoc -lesp_hw_support -lxtensa -lesp_common -lesp_timer -lfreertos -lnewlib -lcxx -lapp_trace -lnghttp -lesp-tls -ltcp_transport -lesp_http_client -lesp_http_server -lesp_https_ota -lsdmmc -lesp_serial_slave_link -lulp -lmbedtls_2 -lmbedcrypto -lmbedx509 -lcoexist -lcore -lespnow -lmesh -lnet80211 -lpp -lsmartconfig -lwapi -lesp_ringbuf -lefuse -lesp_ipc -ldriver -lesp_pm -lmbedtls -lapp_update -lbootloader_support -lspi_flash -lnvs_flash -lpthread -lesp_gdbstub -lespcoredump -lesp_phy -lesp_system -lesp_rom -lhal -lvfs -lesp_eth -ltcpip_adapter -lesp_netif -lesp_event -lwpa_supplicant -lesp_wifi -lconsole -llwip -llog -lheap -lsoc -lesp_hw_support -lxtensa -lesp_common -lesp_timer -lfreertos -lnewlib -lcxx -lapp_trace -lnghttp -lesp-tls -ltcp_transport -lesp_http_client -lesp_http_server -lesp_https_ota -lsdmmc -lesp_serial_slave_link -lulp -lmbedtls_2 -lmbedcrypto -lmbedx509 -lcoexist -lcore -lespnow -lmesh -lnet80211 -lpp -lsmartconfig -lwapi -lesp_ringbuf -lefuse -lesp_ipc -ldriver -lesp_pm -lmbedtls -lapp_update -lbootloader_support -lspi_flash -lnvs_flash -lpthread -lesp_gdbstub -lespcoredump -lesp_phy -lesp_system -lesp_rom -lhal -lvfs -lesp_eth -ltcpip_adapter -lesp_netif -lesp_event -lwpa_supplicant -lesp_wifi -lconsole -llwip -llog -lheap -lsoc -lesp_hw_support -lxtensa -lesp_common -lesp_timer -lfreertos -lnewlib -lcxx -lapp_trace -lnghttp -lesp-tls -ltcp_transport -lesp_http_client -lesp_http_server -lesp_https_ota -lsdmmc -lesp_serial_slave_link -lulp -lmbedtls_2 -lmbedcrypto -lmbedx509 -lcoexist -lcore -lespnow -lmesh -lnet80211 -lpp -lsmartconfig -lwapi -lesp_ringbuf -lefuse -lesp_ipc -ldriver -lesp_pm -lmbedtls -lapp_update -lbootloader_support -lspi_flash -lnvs_flash -lpthread -lesp_gdbstub -lespcoredump -lesp_phy -lesp_system -lesp_rom -lhal -lvfs -lesp_eth -ltcpip_adapter -lesp_netif -lesp_event -lwpa_supplicant -lesp_wifi -lconsole -llwip -llog -lheap -lsoc -lesp_hw_support -lxtensa -lesp_common -lesp_timer -lfreertos -lnewlib -lcxx -lapp_trace -lnghttp -lesp-tls -ltcp_transport -lesp_http_client -lesp_http_server -lesp_https_ota -lsdmmc -lesp_serial_slave_link -lulp -lmbedtls_2 -lmbedcrypto -lmbedx509 -lcoexist -lcore -lespnow -lmesh -lnet80211 -lpp -lsmartconfig -lwapi -lesp_ringbuf -lefuse -lesp_ipc -ldriver -lesp_pm -lmbedtls -lapp_update -lbootloader_support -lspi_flash -lnvs_flash -lpthread -lesp_gdbstub -lespcoredump -lesp_phy -lesp_system -lesp_rom -lhal -lvfs -lesp_eth -ltcpip_adapter -lesp_netif -lesp_event -lwpa_supplicant -lesp_wifi -lconsole -llwip -llog -lheap -lsoc -lesp_hw_support -lxtensa -lesp_common -lesp_timer -lfreertos -lnewlib -lcxx -lapp_trace -lnghttp -lesp-tls -ltcp_transport -lesp_http_client -lesp_http_server -lesp_https_ota -lsdmmc -lesp_serial_slave_link -lulp -lmbedtls_2 -lmbedcrypto -lmbedx509 -lcoexist -lcore -lespnow -lmesh -lnet80211 -lpp -lsmartconfig -lwapi -lphy -lrtc -lesp_phy -lphy -lrtc -lesp_phy -lphy -lrtc -lxt_hal -lcrypt -lm -lnewlib -lstdc++ -lpthread -lgcc -lcxx -lapp_trace -lgcov -lapp_trace -lgcov -lc"


# The configure script in the repo is old. remove it and rebuild:
rm -f configure
autoreconf -vi

# Run the configure script with options for the esp32 platform:
./configure --host=$(./config.guess) --build=xtensa-esp32-elf --prefix= --disable-largefile --disable-protochain --enable-ipv6=no --enable-remote=yes --enable-optimizer-dbg=no --enable-yydebug=no --disable-universal --enable-shared=no --enable-usb=no --enable-netmap=no --enable-bluetooth=no --enable-dbus=no --enable-rdma=no --with-pcap=esp32 CC=${ESP32_TOOLCHAIN_PATH}/xtensa-esp32-elf-gcc CPP=${ESP32_TOOLCHAIN_PATH}/xtensa-esp32-elf-cpp CXX=${ESP32_TOOLCHAIN_PATH}/xtensa-esp32-elf-g++ AR=${ESP32_TOOLCHAIN_PATH}/xtensa-esp32-elf-ar AS=${ESP32_TOOLCHAIN_PATH}/xtensa-esp32-elf-as LD=${ESP32_TOOLCHAIN_PATH}/xtensa-esp32-elf-ld CFLAGS="${ESP32_CDEFINES} ${ESP32_CINCLUDES} ${ESP32_CINCLUDES} ${ESP32_CFLAGS}" LDFLAGS="${ESP32_LDFLAGS}" LIBS="${ESP32_LDADD}" && make clean && make -j8 && make DESTDIR=${ESP32_HOME}/hardware/esp32/${ESP32_VERSION}/tools/sdk/esp32/include/libpcap install

